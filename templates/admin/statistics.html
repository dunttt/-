{% extends "base-ancient.html" %}

{% block title %}æ•°æ®ç»Ÿè®¡ä¸å¯è§†åŒ– - æ‚¦è¯»åŠ{% endblock %}

{% block extra_css %}
<style>
.chart-container {
    background: #fdfcfa;
    border: 2px solid #f0e6d6;
    border-radius: 12px;
    padding: 2rem;
    margin-bottom: 2rem;
    transition: all 0.3s;
}

.chart-container:hover {
    box-shadow: 0 8px 24px rgba(200, 85, 61, 0.15);
    transform: translateY(-2px);
}

.chart-title {
    font-size: 1.3rem;
    font-weight: 700;
    margin-bottom: 1.5rem;
    color: #5a4a3a;
    padding-bottom: 0.75rem;
    border-bottom: 3px solid #c8553d;
}

.stats-overview {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.stat-box {
    background: linear-gradient(135deg, #c8553d 0%, #a0442f 100%);
    color: white;
    padding: 2rem;
    border-radius: 12px;
    text-align: center;
    box-shadow: 0 4px 16px rgba(200, 85, 61, 0.2);
    transition: all 0.3s;
}

.stat-box:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 24px rgba(200, 85, 61, 0.3);
}

.stat-box:nth-child(2) {
    background: linear-gradient(135deg, #5f9e6e 0%, #4a7c58 100%);
    box-shadow: 0 4px 16px rgba(95, 158, 110, 0.2);
}

.stat-box:nth-child(2):hover {
    box-shadow: 0 8px 24px rgba(95, 158, 110, 0.3);
}

.stat-box:nth-child(3) {
    background: linear-gradient(135deg, #d4a259 0%, #b8894a 100%);
    box-shadow: 0 4px 16px rgba(212, 162, 89, 0.2);
}

.stat-box:nth-child(3):hover {
    box-shadow: 0 8px 24px rgba(212, 162, 89, 0.3);
}

.stat-box:nth-child(4) {
    background: linear-gradient(135deg, #7a92a3 0%, #5d7386 100%);
    box-shadow: 0 4px 16px rgba(122, 146, 163, 0.2);
}

.stat-box:nth-child(4):hover {
    box-shadow: 0 8px 24px rgba(122, 146, 163, 0.3);
}

.stat-box:nth-child(5) {
    background: linear-gradient(135deg, #9b6b6f 0%, #7d5659 100%);
    box-shadow: 0 4px 16px rgba(155, 107, 111, 0.2);
}

.stat-box:nth-child(5):hover {
    box-shadow: 0 8px 24px rgba(155, 107, 111, 0.3);
}

.stat-box .value {
    font-size: 2.5rem;
    font-weight: 700;
    margin: 0.5rem 0;
}

.stat-box .label {
    font-size: 1rem;
    opacity: 0.95;
}

.chart {
    width: 100%;
    height: 400px;
}
</style>
{% endblock %}

{% block content %}
<h1 class="page-title" style="text-align: left;">ğŸ“Š æ•°æ®ç»Ÿè®¡ä¸å¯è§†åŒ–</h1>

<!-- æ€»ä½“ç»Ÿè®¡æ¦‚è§ˆ -->
<div class="stats-overview">
    <div class="stat-box">
        <div class="label">ğŸ‘¥ æ€»ç”¨æˆ·æ•°</div>
        <div class="value">{{ total_stats.total_users }}</div>
    </div>
    <div class="stat-box">
        <div class="label">ğŸ“š åœ¨çº¿å°è¯´</div>
        <div class="value">{{ total_stats.total_novels }}</div>
    </div>
    <div class="stat-box">
        <div class="label">ğŸ“– æ€»ç« èŠ‚æ•°</div>
        <div class="value">{{ total_stats.total_chapters }}</div>
    </div>
    <div class="stat-box">
        <div class="label">ğŸ’° è®¢å•æ•°</div>
        <div class="value">{{ total_stats.total_orders }}</div>
    </div>
    <div class="stat-box">
        <div class="label">ğŸ’µ æ€»æ”¶ç›Š</div>
        <div class="value">Â¥{{ '%.2f'|format(total_stats.total_revenue) }}</div>
    </div>
</div>

<!-- å›¾è¡¨åŒºåŸŸ -->
<div class="chart-container">
    <div class="chart-title">ğŸ“Š å°è¯´åˆ†ç±»åˆ†å¸ƒ</div>
    <div id="categoryChart" class="chart"></div>
</div>

<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
    <div class="chart-container">
        <div class="chart-title">ğŸ”¥ çƒ­é—¨å°è¯´Top10ï¼ˆæŒ‰é˜…è¯»é‡ï¼‰</div>
        <div id="topReadChart" class="chart"></div>
    </div>
    
    <div class="chart-container">
        <div class="chart-title">ğŸ’ çƒ­é—¨å°è¯´Top10ï¼ˆæŒ‰é”€é‡ï¼‰</div>
        <div id="topSalesChart" class="chart"></div>
    </div>
</div>

<div class="chart-container">
    <div class="chart-title">âœï¸ åˆ›ä½œè€…ç»Ÿè®¡Top10</div>
    <div id="creatorChart" class="chart"></div>
</div>

<div class="chart-container">
    <div class="chart-title">ğŸ‘¤ ç”¨æˆ·è§’è‰²åˆ†å¸ƒ</div>
    <div id="userRoleChart" class="chart"></div>
</div>
{% endblock %}

{% block extra_js %}
<!-- å¼•å…¥ ECharts -->
<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>

<script>
// å¤é£é…è‰²æ–¹æ¡ˆ
const ancientColors = ['#c8553d', '#8b7355', '#5f9e6e', '#d4a259', '#7a92a3', '#9b6b6f', '#a0442f', '#6d5c47'];

// 1. å°è¯´åˆ†ç±»åˆ†å¸ƒï¼ˆé¥¼å›¾ï¼‰
var categoryChart = echarts.init(document.getElementById('categoryChart'));
var categoryOption = {
    tooltip: {
        trigger: 'item',
        formatter: '{a} <br/>{b}: {c} ({d}%)'
    },
    legend: {
        orient: 'vertical',
        right: 10,
        top: 'center'
    },
    series: [
        {
            name: 'å°è¯´åˆ†ç±»',
            type: 'pie',
            radius: ['40%', '70%'],
            avoidLabelOverlap: false,
            itemStyle: {
                borderRadius: 10,
                borderColor: '#fff',
                borderWidth: 2
            },
            label: {
                show: true,
                formatter: '{b}: {c}'
            },
            emphasis: {
                label: {
                    show: true,
                    fontSize: 16,
                    fontWeight: 'bold'
                }
            },
            data: [
                {% for stat in category_stats %}
                {value: {{ stat.count }}, name: '{{ stat._id }}'},
                {% endfor %}
            ]
        }
    ],
    color: ancientColors
};
categoryChart.setOption(categoryOption);

// 2. çƒ­é—¨å°è¯´Top10ï¼ˆæŒ‰é˜…è¯»é‡ï¼‰- æŸ±çŠ¶å›¾
var topReadChart = echarts.init(document.getElementById('topReadChart'));
var topReadOption = {
    tooltip: {
        trigger: 'axis',
        axisPointer: {
            type: 'shadow'
        }
    },
    grid: {
        left: '3%',
        right: '4%',
        bottom: '3%',
        containLabel: true
    },
    xAxis: {
        type: 'value',
        name: 'é˜…è¯»é‡'
    },
    yAxis: {
        type: 'category',
        data: [
            {% for novel in top_novels_read|reverse %}
            '{{ novel.title[:8] }}...',
            {% endfor %}
        ]
    },
    series: [
        {
            name: 'é˜…è¯»é‡',
            type: 'bar',
            data: [
                {% for novel in top_novels_read|reverse %}
                {{ novel.readCount }},
                {% endfor %}
            ],
            itemStyle: {
                color: new echarts.graphic.LinearGradient(0, 0, 1, 0, [
                    {offset: 0, color: '#c8553d'},
                    {offset: 1, color: '#a0442f'}
                ])
            },
            label: {
                show: true,
                position: 'right'
            }
        }
    ]
};
topReadChart.setOption(topReadOption);

// 3. çƒ­é—¨å°è¯´Top10ï¼ˆæŒ‰é”€é‡ï¼‰- æŸ±çŠ¶å›¾
var topSalesChart = echarts.init(document.getElementById('topSalesChart'));
var topSalesOption = {
    tooltip: {
        trigger: 'axis',
        axisPointer: {
            type: 'shadow'
        }
    },
    grid: {
        left: '3%',
        right: '4%',
        bottom: '3%',
        containLabel: true
    },
    xAxis: {
        type: 'value',
        name: 'é”€é‡'
    },
    yAxis: {
        type: 'category',
        data: [
            {% for novel in top_novels_sales|reverse %}
            '{{ novel.title[:8] }}...',
            {% endfor %}
        ]
    },
    series: [
        {
            name: 'é”€é‡',
            type: 'bar',
            data: [
                {% for novel in top_novels_sales|reverse %}
                {{ novel.saleCount }},
                {% endfor %}
            ],
            itemStyle: {
                color: new echarts.graphic.LinearGradient(0, 0, 1, 0, [
                    {offset: 0, color: '#d4a259'},
                    {offset: 1, color: '#b8894a'}
                ])
            },
            label: {
                show: true,
                position: 'right'
            }
        }
    ]
};
topSalesChart.setOption(topSalesOption);

// 4. åˆ›ä½œè€…ç»Ÿè®¡Top10 - å¤šç³»åˆ—æŸ±çŠ¶å›¾
var creatorChart = echarts.init(document.getElementById('creatorChart'));
var creatorOption = {
    tooltip: {
        trigger: 'axis',
        axisPointer: {
            type: 'shadow'
        }
    },
    legend: {
        data: ['å°è¯´æ•°', 'æ€»é˜…è¯»é‡', 'æ€»é”€é‡']
    },
    grid: {
        left: '3%',
        right: '4%',
        bottom: '3%',
        containLabel: true
    },
    xAxis: {
        type: 'category',
        data: [
            {% for stat in creator_stats %}
            '{{ stat.author_name }}',
            {% endfor %}
        ],
        axisLabel: {
            rotate: 30
        }
    },
    yAxis: {
        type: 'value'
    },
    series: [
        {
            name: 'å°è¯´æ•°',
            type: 'bar',
            data: [
                {% for stat in creator_stats %}
                {{ stat.novelCount }},
                {% endfor %}
            ],
            itemStyle: {
                color: '#c8553d'
            }
        },
        {
            name: 'æ€»é˜…è¯»é‡',
            type: 'bar',
            data: [
                {% for stat in creator_stats %}
                {{ stat.totalRead }},
                {% endfor %}
            ],
            itemStyle: {
                color: '#5f9e6e'
            }
        },
        {
            name: 'æ€»é”€é‡',
            type: 'bar',
            data: [
                {% for stat in creator_stats %}
                {{ stat.totalSales }},
                {% endfor %}
            ],
            itemStyle: {
                color: '#d4a259'
            }
        }
    ]
};
creatorChart.setOption(creatorOption);

// 5. ç”¨æˆ·è§’è‰²åˆ†å¸ƒ - ç¯å½¢å›¾
var userRoleChart = echarts.init(document.getElementById('userRoleChart'));
var roleNames = {
    'admin': 'ç®¡ç†å‘˜',
    'creator': 'åˆ›ä½œè€…',
    'reader': 'è¯»è€…'
};
var userRoleOption = {
    tooltip: {
        trigger: 'item',
        formatter: '{a} <br/>{b}: {c} ({d}%)'
    },
    legend: {
        top: 'center',
        right: 10
    },
    series: [
        {
            name: 'ç”¨æˆ·è§’è‰²',
            type: 'pie',
            radius: ['50%', '70%'],
            center: ['40%', '50%'],
            avoidLabelOverlap: false,
            itemStyle: {
                borderRadius: 10,
                borderColor: '#fff',
                borderWidth: 2
            },
            label: {
                show: true,
                formatter: '{b}: {c}'
            },
            emphasis: {
                label: {
                    show: true,
                    fontSize: 16,
                    fontWeight: 'bold'
                }
            },
            data: [
                {% for stat in user_role_stats %}
                {value: {{ stat.count }}, name: roleNames['{{ stat._id }}'] || '{{ stat._id }}'},
                {% endfor %}
            ]
        }
    ],
    color: ['#c8553d', '#5f9e6e', '#d4a259']
};
userRoleChart.setOption(userRoleOption);

// å“åº”å¼è°ƒæ•´
window.addEventListener('resize', function() {
    categoryChart.resize();
    topReadChart.resize();
    topSalesChart.resize();
    creatorChart.resize();
    userRoleChart.resize();
});
</script>
{% endblock %}
