{% extends "base-ancient.html" %}

{% block title %}{{ novel.title }} - å°è¯´è¯¦æƒ…{% endblock %}

{% block content %}
<!-- å°è¯´è¯¦æƒ…å¡ç‰‡ -->
<div class="card" style="margin-bottom: 2rem;">
    <div style="display: grid; grid-template-columns: 200px 1fr; gap: 2rem;">
        <!-- å°è¯´å°é¢ -->
        <div class="novel-cover" style="width: 200px; height: 280px; background: linear-gradient(135deg, #c8553d 0%, #a0442f 100%); font-size: 3rem;">
            {{ novel.title[:2] }}
        </div>
        
        <!-- å°è¯´ä¿¡æ¯ -->
        <div>
            <h1 style="font-size: 2rem; font-weight: 700; color: #5a4a3a; margin-bottom: 1rem;">
                {{ novel.title }}
            </h1>
            
            <!-- æ ‡ç­¾ -->
            <div style="display: flex; gap: 0.75rem; flex-wrap: wrap; margin-bottom: 1.5rem;">
                <span class="badge badge-primary">{{ novel.category }}</span>
                {% for tag in novel.tags %}
                <span class="badge badge-warning">{{ tag }}</span>
                {% endfor %}
            </div>
            
            <!-- è¯¦ç»†ä¿¡æ¯ -->
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 1.5rem; color: #8b7355;">
                <div>âœï¸ ä½œè€…ï¼š<strong>{{ novel.author_name }}</strong></div>
                <div>ğŸ“– ç« èŠ‚ï¼š<strong>{{ novel.chapters|length }} ç« </strong></div>
                <div>ğŸ‘ï¸ é˜…è¯»é‡ï¼š<strong>{{ novel.readCount }}</strong></div>
                <div>ğŸ“Š é”€é‡ï¼š<strong>{{ novel.saleCount }}</strong></div>
            </div>
            
            <!-- ä»·æ ¼ -->
            <div style="margin-bottom: 1.5rem;">
                {% if novel.price > 0 %}
                <div style="font-size: 2rem; color: #c8553d; font-weight: 700;">
                    Â¥{{ '%.2f'|format(novel.price) }}
                </div>
                {% else %}
                <div style="font-size: 1.5rem; color: #5f9e6e; font-weight: 600;">
                    ğŸ“– å…è´¹é˜…è¯»
                </div>
                {% endif %}
            </div>
            
            <!-- æ“ä½œæŒ‰é’® -->
            {% if purchased %}
            <a href="{{ url_for('reader_read_chapter', novel_id=novel._id, chapter_id=novel.chapters[0].chapterId) }}" class="btn btn-success" style="width: 100%; font-size: 1.1rem; padding: 1rem;">
                ğŸ“– å¼€å§‹é˜…è¯»
            </a>
            {% elif novel.price == 0 %}
            <a href="{{ url_for('reader_read_chapter', novel_id=novel._id, chapter_id=novel.chapters[0].chapterId) }}" class="btn btn-success" style="width: 100%; font-size: 1.1rem; padding: 1rem;">
                ğŸ“– å¼€å§‹é˜…è¯»
            </a>
            {% else %}
            <button class="btn btn-warning" style="width: 100%; font-size: 1.1rem; padding: 1rem;" onclick="purchaseNovel('{{ novel._id }}')">
                ğŸ’° ç«‹å³è´­ä¹°
            </button>
            {% endif %}
        </div>
    </div>
    
    <!-- ç®€ä»‹ -->
    <div style="margin-top: 2rem; padding-top: 2rem; border-top: 2px solid #f0e6d6;">
        <h3 style="font-size: 1.3rem; font-weight: 600; color: #5a4a3a; margin-bottom: 1rem;">
            ğŸ“œ ç®€ä»‹
        </h3>
        <p style="line-height: 2; color: #666; font-size: 1rem; text-indent: 2em;">
            {{ novel.intro }}
        </p>
    </div>
</div>

<!-- ç« èŠ‚åˆ—è¡¨ -->
<div class="card" style="margin-bottom: 2rem;">
    <div class="card-header" style="font-size: 1.2rem; font-weight: 600;">
        ğŸ“š ç« èŠ‚åˆ—è¡¨
    </div>
    <ul style="list-style: none; padding: 0; margin: 0;">
        {% for chapter in novel.chapters %}
        <li style="display: flex; justify-content: space-between; align-items: center; padding: 1rem 1.5rem; border-bottom: 1px solid #f0e6d6; transition: all 0.3s; {% if not loop.last %}{% else %}border-bottom: none;{% endif %}"
            onmouseover="this.style.background='#faf8f3'"
            onmouseout="this.style.background='transparent'">
            <div>
                <strong style="color: #5a4a3a; font-size: 1rem;">{{ chapter.title }}</strong>
                {% if chapter.isFree %}
                <span class="badge badge-success" style="margin-left: 0.75rem;">å…è´¹</span>
                {% else %}
                <span class="badge badge-warning" style="margin-left: 0.75rem;">ä»˜è´¹</span>
                {% endif %}
            </div>
            <div>
                {% if chapter.isFree or purchased or novel.price == 0 %}
                <a href="{{ url_for('reader_read_chapter', novel_id=novel._id, chapter_id=chapter.chapterId) }}" class="btn btn-primary" style="padding: 0.6rem 1.5rem;">
                    é˜…è¯»
                </a>
                {% else %}
                <button class="btn btn-secondary" disabled style="padding: 0.6rem 1.5rem; opacity: 0.5; cursor: not-allowed;">
                    éœ€è´­ä¹°
                </button>
                {% endif %}
            </div>
        </li>
        {% endfor %}
    </ul>
</div>

<!-- è¯„è®ºåŒºåŸŸ -->
<div class="card">
    <div class="card-header" style="font-size: 1.2rem; font-weight: 600;">
        ğŸ’¬ è¯»è€…è¯„è®ºï¼ˆ{{ novel.comments|length }} æ¡ï¼‰
    </div>
    
    <!-- å‘è¡¨è¯„è®ºè¡¨å• -->
    <div style="padding: 1.5rem; background: #faf8f3; border-radius: 8px; margin-bottom: 1.5rem;">
        <h4 style="font-size: 1.1rem; color: #5a4a3a; margin-bottom: 1rem;">âœï¸ å‘è¡¨è¯„è®º</h4>
        <form id="commentForm">
            <div class="form-group">
                <textarea id="commentContent" class="form-control" placeholder="å†™ä¸‹ä½ çš„æƒ³æ³•..." required style="min-height: 100px; border: 2px solid #f0e6d6; border-radius: 8px; padding: 1rem;"></textarea>
            </div>
            <button type="submit" class="btn btn-primary" style="margin-top: 0.5rem;">
                å‘è¡¨è¯„è®º
            </button>
        </form>
    </div>
    
    <!-- è¯„è®ºåˆ—è¡¨ -->
    <div id="commentsList">
        {% if novel.comments %}
            {% for comment in novel.comments %}
            <div style="padding: 1.5rem; border-bottom: 1px solid #f0e6d6; {% if loop.last %}border-bottom: none;{% endif %}" data-index="{{ loop.index0 }}">
                <!-- è¯„è®ºå¤´éƒ¨ -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                    <span style="color: #5a4a3a; font-weight: 600;">
                        ğŸ‘¤ {{ comment.username if comment.username else 'åŒ¿åç”¨æˆ·' }}
                    </span>
                    <span style="color: #8b7355; font-size: 0.9rem;">
                        {{ comment.createTime.strftime('%Y-%m-%d %H:%M') if comment.createTime else '-' }}
                    </span>
                </div>
                
                <!-- è¯„è®ºå†…å®¹ -->
                <div style="color: #666; line-height: 1.8; margin-bottom: 1rem;">
                    {{ comment.content }}
                </div>
                
                <!-- è¯„è®ºæ“ä½œ -->
                <div style="display: flex; gap: 1rem;">
                    <button class="btn btn-secondary" style="padding: 0.4rem 1rem; font-size: 0.9rem;" onclick="showReplyForm({{ loop.index0 }})">
                        ğŸ’¬ å›å¤
                    </button>
                    {% if comment.userId and session.user_id and comment.userId|string == session.user_id %}
                    <button class="btn btn-danger" style="padding: 0.4rem 1rem; font-size: 0.9rem; background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);" onclick="deleteComment({{ loop.index0 }})">
                        ğŸ—‘ï¸ åˆ é™¤
                    </button>
                    {% endif %}
                </div>
                
                <!-- å›å¤è¡¨å•ï¼ˆé»˜è®¤éšè—ï¼‰ -->
                <div id="replyForm{{ loop.index0 }}" style="display: none; margin-top: 1rem; padding: 1rem; background: #faf8f3; border-radius: 8px;">
                    <form onsubmit="submitReply(event, {{ loop.index0 }})">
                        <div class="form-group">
                            <textarea class="form-control" placeholder="å†™ä¸‹ä½ çš„å›å¤..." required style="min-height: 80px; border: 2px solid #f0e6d6; border-radius: 8px; padding: 1rem;"></textarea>
                        </div>
                        <div style="display: flex; gap: 0.75rem; margin-top: 0.75rem;">
                            <button type="submit" class="btn btn-success" style="padding: 0.5rem 1rem;">æäº¤å›å¤</button>
                            <button type="button" class="btn btn-secondary" style="padding: 0.5rem 1rem;" onclick="hideReplyForm({{ loop.index0 }})">å–æ¶ˆ</button>
                        </div>
                    </form>
                </div>
                
                <!-- å›å¤åˆ—è¡¨ -->
                {% if comment.replies %}
                    {% for reply in comment.replies %}
                    <div style="margin-left: 2rem; margin-top: 1rem; padding: 1rem; background: #f7f3ed; border-left: 3px solid #d4a259; border-radius: 4px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <span style="color: #5a4a3a; font-weight: 600; font-size: 0.95rem;">
                                ğŸ‘¤ {{ reply.username if reply.username else 'åŒ¿åç”¨æˆ·' }}
                            </span>
                            <span style="color: #8b7355; font-size: 0.85rem;">
                                {{ reply.createTime.strftime('%Y-%m-%d %H:%M') if reply.createTime else '-' }}
                            </span>
                        </div>
                        <div style="color: #666; line-height: 1.6; font-size: 0.95rem;">
                            {{ reply.content }}
                        </div>
                    </div>
                    {% endfor %}
                {% endif %}
            </div>
            {% endfor %}
        {% else %}
            <div class="empty-state" style="padding: 3rem;">
                <div class="icon">ğŸ’¬</div>
                <h3>æš‚æ— è¯„è®º</h3>
                <p>å¿«æ¥æŠ¢æ²™å‘å§ï¼</p>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function purchaseNovel(novelId) {
    if (!confirm('ç¡®å®šè¦è´­ä¹°è¿™éƒ¨å°è¯´å—ï¼Ÿ')) return;
    
    fetch('/reader/novels/' + novelId + '/purchase', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('è´­ä¹°æˆåŠŸï¼');
            location.reload();
        } else {
            alert(data.message);
        }
    })
    .catch(error => {
        alert('è´­ä¹°å¤±è´¥ï¼Œè¯·é‡è¯•');
        console.error(error);
    });
}

// æäº¤è¯„è®º
document.getElementById('commentForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const content = document.getElementById('commentContent').value;
    const novelId = '{{ novel._id }}';
    
    const formData = new FormData();
    formData.append('content', content);
    
    fetch('/reader/novels/' + novelId + '/comment', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('è¯„è®ºæˆåŠŸï¼');
            location.reload();
        } else {
            alert(data.message);
        }
    })
    .catch(error => {
        alert('è¯„è®ºå¤±è´¥ï¼Œè¯·é‡è¯•');
        console.error(error);
    });
});

// æ˜¾ç¤ºå›å¤è¡¨å•
function showReplyForm(index) {
    const form = document.getElementById('replyForm' + index);
    form.style.display = 'block';
}

// éšè—å›å¤è¡¨å•
function hideReplyForm(index) {
    const form = document.getElementById('replyForm' + index);
    form.style.display = 'none';
}

// æäº¤å›å¤
function submitReply(event, commentIndex) {
    event.preventDefault();
    
    const form = event.target;
    const content = form.querySelector('textarea').value;
    const novelId = '{{ novel._id }}';
    
    const formData = new FormData();
    formData.append('content', content);
    
    fetch('/reader/novels/' + novelId + '/comment/' + commentIndex + '/reply', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('å›å¤æˆåŠŸï¼');
            location.reload();
        } else {
            alert(data.message);
        }
    })
    .catch(error => {
        alert('å›å¤å¤±è´¥ï¼Œè¯·é‡è¯•');
        console.error(error);
    });
}

// åˆ é™¤è¯„è®º
function deleteComment(index) {
    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è¯„è®ºå—ï¼Ÿ')) return;
    
    const novelId = '{{ novel._id }}';
    
    fetch('/reader/novels/' + novelId + '/comment/' + index + '/delete', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('åˆ é™¤æˆåŠŸï¼');
            location.reload();
        } else {
            alert(data.message);
        }
    })
    .catch(error => {
        alert('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•');
        console.error(error);
    });
}
</script>
{% endblock %}
